---
title: "Trajectory analysis"
author: "Rita Grunbreg"
date: "3/25/2020"
output: html_document
---
.csv files from Outplant2019_master.xls from Brooklynn 

METADATA within excel from Brooklynn:
Variable/Header	

PLANT_ID: A number given to an individual plant based on it's  assignment to set a of randomoized inoculation treatments. The IDs are the same as the order the plants were inoculated in, which was also randomized.  	

EPICHL_TRT:	Describes if the plant was germinated from seed that was inoculated with Epichloe ( inoculated) or from seed that was not inoculated with Epichloe (free)	

COLLET_TRT:	Describes if the plant was subjected to an inoculum of Colletotrichum spores (inoculated) or subjected to a solution of blank media inoculum, absent of colletotrichum spores (mock)	

RHIZOC_TRT:	Describes if the plant was subjected to an inoculum plug of Rhizoctonia myeclia (inoculated) or subjected to a plug of blank media, absent of Rhizoctonia mycelia (mock)

Treatment_Code:	An code/nickname given to the treatments of the plant based on the epichloe, colletotrichum, or rhizoctonia inoculation						
									
Survey.event:	13 surveys were conducted biweekly over a period of 6 weeks. This column indicates the surveys in chronological order								
Plot.Location:	Refer to field map. The experimental plot contained 141 holes in which to place potted outplants. The holes are named as plot.locations according to their row and hole position. Outplants were randomly assigned a new plot location once per week (every monday)								
Treatment:	A treatment code that refers to the o the inoculation treatments that a plant was subjected to. Refer to "treatments" tab								
Plant.ID:	Unique ID of plant		

Tiller.ID:	ID of tiller surveyed on plant. First tillers were randomly selected to be surveyed longitudinally. If the first tiller died or produced a daughter tiller, then a new tiller was assigned (ID of 2) for surveying, and so on.

Leaf.ID:	Leaf 1 is the oldest living leaf on the tiller at the start of the experiment. This is also the inoculated or mock-inoculated leaf. 								
Damage:	Indicates if a leaf is damaged (D), not damaged (ND), is no leaf is present (NL). If the plant is unable to be surveyed for any reason, such as death, NA's are present. 		

Chew:	indicates insect damage from chewing is present on leaf		

Scrape: 	indicates insect or mollusk damage from scraping is present on leaf	

Mechanical: 	indicates that the leaf has been mechanically damaged from handling or some other event.

Chlorosis:	Indicates that some portion of the leaf is presentinga form of  chlorosis		

Col:	Indicates if Colletotrichum symptoms are observed on the leaf								
%Col:	Indicates the severity of colletorichum symptoms on the leaf								
#C.lesions:	Indicates the individual number of lesions that can be discerned on the leaf	

Rhiz:	Indicates if Rhizoctonia symptoms are observed on the leaf								
%Rhiz:	Indicates the severity of Rhizoctonia symptoms on the leaf								
#R.lesions:	Indicates the individual number of lesions that can be discerned on the leaf	

Rust:	Indicates if Rust symptoms are observed on the leaf								
%Rust:	Indicates the severity of Rust symptoms on the leaf								
#P.lesions:	Indicates the individual number of pustules that are observed on the leaf	

GLS:	Indicates if Gray Leaf Spot symptoms are observed on the leaf								
%GLS:	Indicates the severity of Gray Leaf Spot symptoms observed on the leaf								
#GLS.lesions:	Indicates the individual number of Gray Leaf Spot lesions that can be discerned on the leaf	

Epichloe.presence:	Indicates if the fungal endophyte, epichloe, was confirmed present in the tiller after the experiment ended. Epichloe was confirmed via a field tiller immunoblot purchased from Agrinostics. 	

~~~~~ NOTE REMOVE PLANT 8 -- DEAD WHEN EXPERIMENT STARTED ~~~~~~

```{r setup,  results='hide', message=FALSE, warning=FALSE}
rm(list = ls())  # clear Rs brain 
library(readr)   # read csv file
library(tidyr)   # tidying data
library(dplyr)   # manipulating df
library(ggplot2) # graphing
library(ggpubr)  # nice package for figures
library(vegan)   # nmds 
library(trend)   # mann-kendell trend test
library(agricolae)#AUDPS
library(car) #type 3 anovas
library(segmented)#for piecewise regression model
library(nlme) #mixed model to be used in piecewise model 
library(DescTools) #effect sizes 
###############################################################################################################
Outplant2019_infection <- read_csv("C:/Users/grunberg/Documents/GitHub/2019-outplant-experiment/Data/Outplant2019_infection.csv")
Outplant2019_biomass <- read_csv("C:/Users/grunberg/Documents/GitHub/2019-outplant-experiment/Data/Outplant2019_biomass.csv")
Outplant2019_treatments <- read_csv("C:/Users/grunberg/Documents/GitHub/2019-outplant-experiment/Data/Outplant2019_treatments.csv")
parasite_all <- read_csv("C:/Users/grunberg/Documents/GitHub/2019-outplant-experiment/Data/NMDS_coordinates_outplant2019_BC_uninfectedleavesremoved.csv")

set.seed(123456789)
```
Formatting outplant csv files 

Includes making plotting theme
Getting sample sizes 

```{r formatting}
rita_theme <-  theme_classic(base_size = 15)+
  theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5),
        legend.position=c(0.15,0.18),
        axis.line = element_line(colour = 'black', size = 0.75),
        axis.ticks = element_line(colour = "black", size = 0.75),
        axis.text.x = element_text(size=12,  colour = "black"), 
        axis.text.y = element_text(size=12,  colour = "black"), # bold
        axis.title.y = element_text(size=14, colour = "black")
  )

#remove extra column 
parasite_all <- parasite_all %>% dplyr::select(-c(X1))
#check out treatment groups
unique(Outplant2019_treatments$EPICHL_TRT)
unique(Outplant2019_treatments$COLLET_TRT)
unique(Outplant2019_treatments$RHIZOC_TRT)

Outplant2019_treatments %>%
  group_by(Treatment_Code)%>%
  summarise(N_total = n())%>%
  mutate(total= sum(N_total))

unique(Outplant2019_infection$Survey.Date)

#fix, otherwise R will treat this as another level for this factor 
Outplant2019_treatments$COLLET_TRT<-gsub("Inoculated", "inoculated", Outplant2019_treatments$COLLET_TRT)
Outplant2019_treatments$RHIZOC_TRT<-gsub("Inoculated", "inoculated", Outplant2019_treatments$RHIZOC_TRT)

#check it was fixed 
unique(Outplant2019_treatments$COLLET_TRT)
unique(Outplant2019_treatments$RHIZOC_TRT)

#easier to interpret treatment codes; useful for plotting
Treat <- c("Epi (+)", 
           "Epi (+) Col (+) Rhiz (+)",
           "Epi (-)", 
           "Epi (-) Rhiz (+)",
           "Epi (-) Col (+)",
           "Epi (+) Rhiz (+)",
           "Epi (+) Col (+)",
           "Epi (-) Col (+) Rhiz (+)"
)

Treat.better <- c("Epi", 
           "Epi + Col + Rhiz +",
           "No Symbiont", 
           "Rhiz",
           "Col",
           "Epi + Rhiz",
           "Epi + Col",
           "Col + Rhiz"
)

# merge new treatment codes with old treatment.code; easier to merge Dfs in the future 
Treatment.code <- unique(Outplant2019_infection$Treatment.code)
full_treament <- data.frame(Treatment.code,Treat, Treat.better)

Outplant2019_infection %>%
  group_by(Treatment.code) %>%
  summarise(plant_sample = n_distinct(PLANT_ID))

#change then name for biomass 
Outplant2019_biomass.2 <-Outplant2019_biomass %>% 
  mutate(biomass = Outplant2019_biomass$`Oven-dried.weight(g)`) %>%
  dplyr::select(c(1,2,12))

#check plant 8 with no infection
check8 <-Outplant2019_infection %>%
  filter(PLANT_ID==8)
check19 <-Outplant2019_infection %>%
  filter(PLANT_ID==19)
check69 <-Outplant2019_infection %>%
  filter(PLANT_ID==68)

#filter leaves that were not present, so removing NL observations 
#add days for analysis
sample_days <-data.frame(Survey.Date=unique(Outplant2019_infection$Survey.Date),
                         days=c(1, 4, 6, 11,14, 18, 21, 25, 28, 32, 35, 39,42)
                         )

Outplant2019_infection <- merge(Outplant2019_infection, sample_days, by = c('Survey.Date'))

Outplant2019_infection2 <- Outplant2019_infection %>%
 # dplyr::select(1:25) %>%
  filter(Damage %in% c("D", "ND"))  # removing no leaf data = "NL"

Outplant2019_infection2  %>% 
  unite(plantleaf, PLANT_ID, Leaf.ID, Tiller.ID, sep = '_') %>% #merge characters from columns into one thing
  summarise(leaf_sample = n_distinct(plantleaf))

# merge dfs into one master dataset
Outplant2019_infection2 <- merge(Outplant2019_infection2, full_treament, by = "Treatment.code")
outplant_data <- merge(Outplant2019_infection2, Outplant2019_biomass.2, by = "PLANT_ID")
outplant_data <- merge(outplant_data, Outplant2019_treatments, by = "PLANT_ID") 

head(outplant_data)

outplant_data <- outplant_data %>%
  mutate_at(c('PLANT_ID','Survey.event', 'Leaf.ID', "Tiller.ID"), as.factor) %>% #convert columns to factors 
  mutate(sp_rich = specnumber(outplant_data[c(14,17,20,23)]),
         shannon = diversity(outplant_data[c(14,17,20,23)], index="shannon"),
         simpson = diversity(outplant_data[c(14,17,20,23)], index="simpson"),
         )%>%
  filter(!(PLANT_ID==8))%>% # remove plant 8; also plANT 19 was never infected 
  group_by(PLANT_ID, Leaf.ID) %>%
  mutate(leaf_first = min(days),
         leaf_last = max(days),
         leaf_span = leaf_last - leaf_first,
         num_surveys = n_distinct(Survey.event))%>%
  ungroup()%>%
  group_by(PLANT_ID, Leaf.ID, Survey.event)%>%
  mutate(leaf_age = days- leaf_first)%>%
  ungroup()

outplant_data$total_damage <- rowSums(outplant_data[c(14,17,20,23)]) 
max(outplant_data$total_damage)
max(outplant_data$`%Col`)
max(outplant_data$`%Rhiz`)
max(outplant_data$`%Rust`)
max(outplant_data$`%GLS`)

min(outplant_data$total_damage)


```
Leaf production defined as number of leaves within a plant over the experiment 
Leaf retention; # of leaves still alive at the end of the experiment 
Leaf lifespan # days leaf is alive 

```{r leaf lifespan}
leafretentation <- outplant_data %>%
  group_by(PLANT_ID, Leaf.ID, Tiller.ID)%>%
  mutate(alldamage = sum(total_damage)) %>%
  filter(alldamage >0 ) %>% ungroup()%>%
  group_by(PLANT_ID, Treat, Survey.event, Leaf.ID) %>%
  summarise_at('leaf_span', mean) %>% ungroup()%>%
  filter(Survey.event %in% c("1", "13")) %>% # filter first and final survey 
  group_by(PLANT_ID, Treat, Leaf.ID) %>%
  tally() %>%
  mutate(num_retained = n -1 )%>%
  group_by(PLANT_ID, Treat) %>%
  summarise(leaf_retained = sum(num_retained))

leafretentation %>% 
  ggplot() +
    geom_violin(aes(x=Treat, y = (leaf_retained), fill=Treat), alpha=0.2) +
 geom_point(aes(x=Treat, y = (leaf_retained), fill=Treat),pch=21, size=2,
             position=position_jitterdodge(dodge.width=1,  jitter.width = 0.75)) +
  scale_fill_manual(values=c('#762a83','#9970ab','#c2a5cf','#e7d4e8',
                                 '#d9f0d3','#a6dba0','#5aae61','#1b7837')) + 
  guides(fill=FALSE)+
  labs(x="", y="# leaves retained")+
  rita_theme+
  theme(axis.text.x = element_text( angle=90, hjust = 1, vjust = 0.5)) 


leaflife <- outplant_data %>%
  group_by(PLANT_ID, Treat)%>% 
  mutate(Leaf.num = as.numeric(Leaf.ID),
            total_leaves = max(Leaf.num)) %>%
  ungroup()%>%
  group_by(PLANT_ID)%>%
  mutate(alldamage = sum(total_damage)) %>%
  filter(alldamage >0 ) %>% ungroup()%>%
  group_by(PLANT_ID, Leaf.ID, Treat, EPICHL_TRT, RHIZOC_TRT, COLLET_TRT) %>%
  summarise_at(c("leaf_span", "leaf_first", "leaf_last", "total_leaves", "Leaf.num", "num_surveys"), mean)

avg_life <-leaflife %>%
  filter(Leaf.num < 4)%>%
  group_by(PLANT_ID, Treat) %>%
  summarise_at(c("leaf_span", "total_leaves"), mean)

life.mod <- aov((leaf_span)  ~ Treat, data= avg_life)
plot(life.mod)
summary(life.mod)

avg_life %>% 
  ggplot() +
  geom_boxplot(aes(x=Treat, y = (leaf_span), fill=Treat)) +
  scale_fill_manual(values=c('#762a83','#9970ab','#c2a5cf','#e7d4e8',
                                 '#d9f0d3','#a6dba0','#5aae61','#1b7837')) + 
  guides(fill=FALSE)+
  labs(x="", y="avg. lifespan of leaves 1-3")+
  rita_theme+
  theme(axis.text.x = element_text( angle=90, hjust = 1, vjust = 0.5)) 

```

```{r leaf days surveyed}

order_trt <-c( "2Epi (+)"        ,
               "8Epi (+) Col (+) Rhiz (+)",
               "1Epi (-)"      ,
               "5Epi (-) Rhiz (+)" ,
               "3Epi (-) Col (+)"    ,
               "6Epi (+) Rhiz (+)"  ,
               "4Epi (+) Col (+)"    ,
               "7Epi (-) Col (+) Rhiz (+)")

full_treament$ordered_trt <- order_trt
leaflife <- merge(leaflife, full_treament, by = "Treat")   

treatment_names <- list(
"2Epi (+)"    = "Epi",
"8Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
 "1Epi (-)"    = "No symbiont",
"5Epi (-) Rhiz (+)"   = "Rhiz",
 "3Epi (-) Col (+)"    ="Col",
"6Epi (+) Rhiz (+)"  = "Epi + Rhiz",
"4Epi (+) Col (+)" ="Epi + Col",
"7Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz"
)

treatment_labeller <- function(variable,value){
  return(treatment_names[value])
}


leaf1 <-leaflife%>%
  ggplot(aes(x=Leaf.ID, y = num_surveys, ordered_trt))+
  geom_boxplot()+
  facet_wrap(~ordered_trt, labeller = treatment_labeller, ncol=2, nrow=4)+
  scale_fill_manual(values=c('white','white','white','white',
                             'white','white','white','white')) + 
  rita_theme+
  guides(fill=FALSE)+ labs(x="Leaf ID", y="# of times surveyed")+
   theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 12))+ 
  scale_y_continuous(breaks = seq(0, 14, by = 2))


#jpeg(filename="daysallleafsurveyed.jpeg", width=200, height= 300, units="mm", bg="white", res=300)
leaf1
#dev.off()


inoculated <- leaflife %>% group_by(PLANT_ID) %>%
  mutate(totalsurvey = sum(num_surveys)) %>%
  ungroup()%>%
  group_by(PLANT_ID, Leaf.ID)%>%
  mutate(contribution = num_surveys/totalsurvey)%>% ungroup() %>%
  filter(Leaf.ID=='1')%>%
  mutate(mean_contribution = mean(contribution),
         max_contribution = max(contribution),
         min_contribution = min(contribution))
  
```

```{r leaf inoculation}
leafinco <-leaflife%>% 
  filter(Leaf.ID =='1')%>%
  ggplot(aes(x=Treat, y = num_surveys, group=Treat))+
  geom_violin(aes(x=Treat, y = num_surveys, group=Treat)
            #color='#bdbdbd', alpha=0.3
            )+
    geom_sina(aes(x=Treat, y = num_surveys, group=Treat),
              pch=21, alpha=0.75, size=2
            #color='#bdbdbd', alpha=0.3
            )+
#  geom_point(aes(x=Treat, y = num_surveys, fill=Treat), pch=21, alpha=0.7, size = 2,
 #            position=position_jitterdodge(dodge.width=1,  jitter.height = 0.3, jitter.width = 0.3))+
 # geom_point(aes(x=Treat, y = mean_life), pch=21, size=3)+
  rita_theme+
  scale_x_discrete(labels=c("Epi (+)"    = "Epi",
                            "Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
                            "Epi (-)"    = "No symbiont",
                            "Epi (-) Rhiz (+)"   = "Rhiz",
                            "Epi (-) Col (+)"    ="Col",
                            "Epi (+) Rhiz (+)"  = "Epi + Rhiz",
                            "Epi (+) Col (+)" ="Epi + Col",
                            "Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz")
                   )+
  labs(x="",y="# times inoculated leaf was surveyed")+
  scale_fill_manual(values=c('white','white','white','white',
                             'white','white','white','white')) + 
  theme(axis.text.x = element_text( angle=0, hjust = 1, vjust = 0.5),
      #  panel.grid.minor  = element_line(colour="grey", size=0.25),
        panel.grid.major  = element_line(colour="grey", size=0.25)
        ) +
  scale_y_continuous(breaks = seq(0, 13, by = 1))+
  coord_flip()+
  guides(fill=FALSE)

#jpeg(filename="daysinoculatedleafsurveyed.jpeg", width=180, height= 120, units="mm", bg="white", res=300)
leafinco
#dev.off()

```

```{r leaf production analysis}
leafdemographics <- outplant_data %>%
  group_by(PLANT_ID, Treat, Survey.event)%>% 
  mutate(Leaf.num = as.numeric(Leaf.ID),
            total_leaves = max(Leaf.num)) %>%
  ungroup()%>%
  group_by(PLANT_ID,  days, Survey.event, Treat, EPICHL_TRT, RHIZOC_TRT, COLLET_TRT) %>%
  summarise(total_leaves = mean(total_leaves),
            mean_age = mean(leaf_age),
            var_age = sd(leaf_age),
            cv_age = var_age/mean_age)%>%
  mutate_at(vars(cv_age), ~replace(., is.nan(.), 0))

leafabundance <- outplant_data %>%
  group_by(PLANT_ID, Treat, Survey.event)%>% 
  mutate(Leaf.num = as.numeric(Leaf.ID),
        total_leaves = max(Leaf.num)) %>%
  ungroup()%>%
  group_by(PLANT_ID, Treat, EPICHL_TRT, RHIZOC_TRT, COLLET_TRT) %>%
  summarise(mean_leaves = mean(total_leaves),
            var_leaves = sd(total_leaves),
            cv_leaves = var_leaves/ mean_leaves)


leafabundance <- merge(leafabundance, slopes_leaf_production, by = c("PLANT_ID", "Treat"))

```



Next I am calculating some basic diversity metrics (e.g., richness, shannon and simpson)and then formatting a DF that contains plant-level observations for pathogen severity to be used for the ordination  


```{r infections plant}
# removes leafs that were never infected in the experiment 
outplant_data_infected <- outplant_data%>% 
  ungroup()%>%
  group_by(PLANT_ID, Leaf.ID, Tiller.ID)%>%
  mutate(alldamage = sum(total_damage)) %>%
  filter(alldamage >0 )

leaf_observation <- as.matrix.data.frame(xtabs(~ PLANT_ID + Leaf.ID, data=outplant_data_infected))
leaf_observation<-apply(leaf_observation,2, function(x) {ifelse(x==0,0,1)})#makes presence-absence matrix
leaf_observation <-as.data.frame(leaf_observation)

# number of observations at leaf 3
sum(leaf_observation$V3)
# number of observations at leaf 4
sum(leaf_observation$V4)

# here is the ending sample size for the plants included in the anlaysis 
outplant_data_infected %>% 
  group_by(Treat, PLANT_ID) %>% 
  summarise(meandamage = mean(alldamage)) %>%
  group_by(Treat) %>%
  summarise(plant_sample = n_distinct(PLANT_ID))

outplant_data_infected %>% 
  group_by( PLANT_ID) %>% 
  summarise(meandamage = mean(alldamage)) %>%
  summarise(plant_sample = n_distinct(PLANT_ID))
#infection by parasite species 

outplant_data_infected %>% 
  group_by( PLANT_ID) %>% 
  summarise(totalcol = mean(Col)) %>%
  filter(totalcol>0)%>%
  summarise(plant_sample = n_distinct(PLANT_ID))

outplant_data_infected %>% 
  group_by( PLANT_ID) %>% 
  summarise(totalrhiz = mean(Rhiz)) %>%
  filter(totalrhiz>0)%>%
  summarise(plant_sample = n_distinct(PLANT_ID))

outplant_data_infected %>% 
  group_by( PLANT_ID) %>% 
  summarise(totalrust = mean(Rust)) %>%
  filter(totalrust>0)%>%
  summarise(plant_sample = n_distinct(PLANT_ID))

outplant_data_infected %>% 
  group_by( PLANT_ID) %>% 
  summarise(totalGLS = mean(GLS)) %>%
  filter(totalGLS>0)%>%
  summarise(plant_sample = n_distinct(PLANT_ID))

```

```{r diversity metrics and plant_level df}
plant_level_outplant_infected <- outplant_data_infected%>%
  rename(col_sev = '%Col', rhiz_sev = "%Rhiz", rust_sev = "%Rust", gls_sev = "%GLS", epichloe = 'Epichloe.presence.x')%>%
  group_by(PLANT_ID, Treatment.code, Survey.event, days,Treat, EPICHL_TRT,COLLET_TRT, RHIZOC_TRT, Treat.better) %>%
  summarise_at(c("col_sev", "rhiz_sev", "rust_sev", "gls_sev", "epichloe", 'total_damage', 'biomass'),
               mean, na.rm = TRUE) %>% ungroup() %>%
  replace(., is.na(.), 0) %>%
  mutate_at(c('Survey.event'), as.numeric)%>%
  mutate(dummy_p = rep(1)) 

plant_level_outplant_semi <- merge(plant_level_outplant_infected, leafdemographics,
                              by = c("PLANT_ID", "days", "Survey.event", "Treat", "EPICHL_TRT","COLLET_TRT", "RHIZOC_TRT") )
plant_level_outplant <- merge(plant_level_outplant_semi, leafabundance,
                              by = c("PLANT_ID",  "Treat", "EPICHL_TRT","COLLET_TRT", "RHIZOC_TRT") )
```

```{r leaf 1 survival}
leafinco <-leaflife%>% 
  filter(Leaf.ID =='1')

inocsurvey.1 <-aov(num_surveys ~ EPICHL_TRT* COLLET_TRT* RHIZOC_TRT, data = leafinco)
summary(inocsurvey.1)
EtaSq(inocsurvey.1)

inocsurvey.1 <-aov(num_surveys ~ Treat, data = leafinco)
summary(inocsurvey.1)
out.s <-HSD.test(inocsurvey.1, "Treat", group=TRUE)
out.s
```

I established patterns of similarity using non-metric multi-dimensional scaling on Bray-Curtis distances based on parasite infection severity at the plant-level (i.e., severity averaged across all leaves nested within a plant). Although infections are localized within a leaf, I used plant-level severity because infections at the leaf-level are not independent, and this method retains the plant as the experimental unit. At the start of the experiment most hosts were uninfected, and in order to retain those uninfected hosts I included a dummy variable (dummp_p) into the parasite community matrix. The inclusion of the dummy variable causes uninfected hosts to cluster together, so most hosts will start at the same community state (i.e., have the same NMDS coordinates). The parasite community matrix contained 4 fungal pathogens and the dummy variable. Because infection severity varies considerably across parasite species, I standardized severity based on each species maximum to facilitate a more uniform weighting across species. 

```{r NMDS}
# create community matrix and envi data matrix 
p_matrix<-plant_level_outplant[,c(9:12,16)] # matrix without epichloe presence 
p_envi<-plant_level_outplant[,1:8] # matrix with relevant treatment data 

# remove columns 
p_matrix<-p_matrix[, colSums(abs(p_matrix)) !=0] # removes columns with all zeros

# remove rows without parasites; this should do nothing now bc we added dummy_p
p01<-p_matrix[rowSums(abs(p_matrix))!=0,]  # remove rows with no parasites
envi01<-p_envi[rowSums(abs(p_matrix))!=0,]  # remove rows with no parasites 

#standardize values to unit maximum 
pt<-apply(p01,2, function(x) x/max(x)) #exclude epichloe 

#note these NMDS will take forever, so imported them from a csv file from a prior run to save time
# # global nmds
set.seed(123456789)
 #ordO_pt<-metaMDS(pt, distance="bray", trymax = 500, autotransform=FALSE)
 #ordO_pt

 # parasite <- c(" Colletotrichum ", "Rhizoctonia ", "Puccinia", "Pyricularia",#"Epichloe",
 # "Dummy")
 # hcoordO<-as.data.frame(scores(ordO_pt, display="sites"))#extracts coordinates for plot
 # pcoordO<-scores(ordO_pt, display="species")#extracts coordinates for parasite vectors
 # pcoordO <-as.data.frame(pcoordO)
 # pcoordO$parasite <- parasite
 # write.csv(pcoordO, "NMDS_parasitecoordinates.csv")
 # 
 #parasite_all <- bind_cols(envi01, hcoordO)
 #write.csv(parasite_all, "NMDS_coordinates_outplant2019_BC_uninfectedleavesremoved.csv")

```
Call:
metaMDS(comm = pt, distance = "bray", trymax = 500, autotransform = FALSE) 

global Multidimensional Scaling using monoMDS

Data:     pt 
Distance: bray 

Dimensions: 2 
Stress:     0.04293387 
Stress type 1, weak ties
No convergent solutions - best solution after 500 tries
Scaling: centring, PC rotation, halfchange scaling 
Species: expanded scores based on ‘pt’ 


###### uninfected hosts/leaves excluded from analysis; below


Call:
metaMDS(comm = pt, distance = "bray", trymax = 500, autotransform = FALSE) 

global Multidimensional Scaling using monoMDS

Data:     pt 
Distance: bray 

Dimensions: 2 
Stress:     0.04185994 
Stress type 1, weak ties
No convergent solutions - best solution after 500 tries
Scaling: centring, PC rotation, halfchange scaling 
Species: expanded scores based on ‘pt’ 
```{r betadispersion}
dis<-vegdist(pt)
#calcul mutlv dispersion
disp.mod <- betadisper(dis, envi01$days, type='centroid')
disp.mod.2 <- betadisper(dis, envi01$Treat, type='centroid')

anova(disp.mod)
anova(disp.mod.2)

## Permutation test for F
perm.mod <-permutest(disp.mod, pairwise = TRUE, permutations = 999)
perm.mod

## Tukey's Honest Significant Differences
(disp.mod.HSD <- TukeyHSD(disp.mod))
plot(disp.mod.HSD)

(disp.mod.HSD.2 <- TukeyHSD(disp.mod.2))
post.beta <-disp.mod.HSD.2$group %>% as.data.frame()
plot(disp.mod.HSD.2)


## Plot the groups and distances to centroids on the
## first two PCoA axes
#plot(disp.mod)

jpeg(filename="distance_to_centroid_supp.jpeg", width=140, height=90, units="mm", bg="white", res=300)
par(mar = c(4, 4, 1, 1)) # Set the margin on all sides to 2
boxplot(disp.mod, xlab="days")
dev.off()

jpeg(filename="distance_to_centroid_supp.jpeg", width=140, height=90, units="mm", bg="white", res=300)
par(mar = c(4, 4, 1, 1)) # Set the margin on all sides to 2
boxplot(disp.mod.2, xlab="treat")
dev.off()
```
ANOVA
Response: Distances
            Df  Sum Sq  Mean Sq F value    Pr(>F)    
Groups      12 0.24089 0.020074  19.321 < 2.2e-16 ***
Residuals 1583 1.64467 0.001039                      
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Permutation test for homogeneity of multivariate dispersions
Permutation: free
Number of permutations: 99

Response: Distances
            Df  Sum Sq  Mean Sq      F N.Perm Pr(>F)   
Groups      12 0.24089 0.020074 19.321     99   0.01 **
Residuals 1583 1.64467 0.001039                        
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

```{r NMDS centroids}
#scrsparasite <-scores(ordO_pt, display = "sites", "species")
cent <- parasite_all %>%
  group_by(Treat, Survey.event) %>%
  summarise_at(c("NMDS1", 'NMDS2'), mean)
```
Try renaming the labels for the facet wrap 


```{r graphic_NMDS}
topp<-max(parasite_all[,8:9]) #determines maximum and minimum values for the plot axes
bott<-min(parasite_all[,8:9]) #I draw from both data sets because I make the graph sqaure and

order_trt <-c( "2Epi (+)"        ,
               "8Epi (+) Col (+) Rhiz (+)",
               "1Epi (-)"      ,
               "5Epi (-) Rhiz (+)" ,
               "3Epi (-) Col (+)"    ,
               "6Epi (+) Rhiz (+)"  ,
               "4Epi (+) Col (+)"    ,
               "7Epi (-) Col (+) Rhiz (+)")

full_treament$ordered_trt <- order_trt
parasite_all<- merge(parasite_all, full_treament, by = "Treat")   

treatment_names <- list(
"2Epi (+)"    = "Epi",
"8Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
 "1Epi (-)"    = "No symbiont",
"5Epi (-) Rhiz (+)"   = "Rhiz",
 "3Epi (-) Col (+)"    ="Col",
"6Epi (+) Rhiz (+)"  = "Epi + Rhiz",
"4Epi (+) Col (+)" ="Epi + Col",
"7Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz"
)

treatment_labeller <- function(variable,value){
  return(treatment_names[value])
}

#jpeg(filename="outplant_NMDS_8removed_BC.jpeg", width=180, height=110, units="mm", bg="white", res=300)
ggplot(parasite_all, aes(x= NMDS1, y=NMDS2))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_point( size =3,  pch=21)+
  xlab("NMDS 1") +
  ylab("NMDS 2") +
  # xlim(c( bott-0.1, topp+0.1)) +
  #ylim(c( bott-0.1, topp+0.1)) +
  theme_pubr() +
  theme(legend.text = element_text(size=8), legend.box = "horizontal",
        legend.title = element_text(size=9, face="bold"),
        legend.position=c(0.13,0.85)) +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(plot.title = element_text(hjust = 0.5, size=15, face="bold")) + # guides(shape=FALSE)+ 
  facet_wrap(~ordered_trt,
             ncol = 2, nrow = 4,
             labeller=treatment_labeller)+
  guides(fill=FALSE, color=FALSE)+
 # geom_text(data=pcoordO, aes(x=NMDS1,y=NMDS2, label=parasite), fontface =1, colour = "black" , size=4) + # plant species label 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15)) # add black square panel around graphic
#dev.off()
```

```{r rename labels for panel}

order_trt <-c( "2Epi (+)"        ,
               "8Epi (+) Col (+) Rhiz (+)",
               "1Epi (-)"      ,
               "5Epi (-) Rhiz (+)" ,
               "3Epi (-) Col (+)"    ,
               "6Epi (+) Rhiz (+)"  ,
               "4Epi (+) Col (+)"    ,
               "7Epi (-) Col (+) Rhiz (+)")

full_treament$ordered_trt <- order_trt
cent <- merge(cent, full_treament, by = "Treat")   

treatment_names <- list(
"2Epi (+)"    = "Epi",
"8Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
 "1Epi (-)"    = "No symbiont",
"5Epi (-) Rhiz (+)"   = "Rhiz",
 "3Epi (-) Col (+)"    ="Col",
"6Epi (+) Rhiz (+)"  = "Epi + Rhiz",
"4Epi (+) Col (+)" ="Epi + Col",
"7Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz"
)

treatment_labeller <- function(variable,value){
  return(treatment_names[value])
}
```

```{r nmds with all data and centroids}
topp<-max(parasite_all[,9:10]) #determines maximum and minimum values for the plot axes
bott<-min(parasite_all[,9:10]) #I draw from both data sets because I make the graph sqaure and

#jpeg(filename="figure1_centroids_alldata.jpeg", width=180, height=270, units="mm", bg="white", res=300)
ggplot(parasite_all, aes(x= NMDS1, y=NMDS2))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_point(data=parasite_all, aes(x= NMDS1, y=NMDS2), size =2,  pch=21, color='grey')+
  geom_point(data=cent, aes(x= NMDS1, y=NMDS2),size =4.25, fill='white',pch=21 )+
  xlab("NMDS 1") +
  ylab("NMDS 2") +
  # xlim(c( bott-0.1, topp+0.1)) +
  #ylim(c( bott-0.1, topp+0.1)) +
  theme_pubr() +
  theme(legend.text = element_text(size=8), legend.box = "horizontal",
        legend.title = element_text(size=9, face="bold"),
        legend.position=c(0.13,0.85)) +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(plot.title = element_text(hjust = 0.5, size=15, face="bold")) + # guides(shape=FALSE)+ 
  facet_wrap(~ordered_trt,
             ncol = 2, nrow = 4,
             labeller=treatment_labeller)+
  guides(fill=FALSE, color=FALSE)+
 # geom_text(data=pcoordO, aes(x=NMDS1,y=NMDS2, label=parasite), fontface =1, colour = "black" , size=4) + # plant species label 
  geom_text(aes(x=NMDS1,y=NMDS2, label=Survey.event), fontface =2.5, colour = "black" , size=2, data=cent) + # plant species label 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15))
#dev.off()

```

```{r graphic_nmds_centroid}
topp<-max(cent[,3:4]) #determines maximum and minimum values for the plot axes
bott<-min(cent[,3:4]) #I draw from both data sets because I make the graph sqaure and

#jpeg(filename="outplant_centroids_NMDS_removeuninfectedleaves.jpeg", width=180, height=270, units="mm", bg="white", res=300)
ggplot(cent, aes(x= NMDS1, y=NMDS2))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_path(#aes(color=Treat),
    color="grey", lwd=1)+
  #geom_line(aes(color=Treat), lwd=1.5)+
  geom_point(size =4.25, fill='white', #aes(fill=Treat),
             pch=21)+
  xlab("NMDS 1") +
  ylab("NMDS 2") +
  xlim(c( bott, topp)) +
  ylim(c( bott, topp)) +
  # geom_text(data=pcoordO, aes(x=NMDS1,y=NMDS2, label=parasite), fontface =2, colour = "black" , size=2) + # parasite species label 
  geom_text(aes(x=NMDS1,y=NMDS2, label=Survey.event), fontface =2.5, colour = "black" , size=2) + # plant species label 
  theme_pubr() +
  theme(legend.text = element_text(size=8), legend.box = "horizontal",
        legend.title = element_text(size=9, face="bold"),
        legend.position=c(0.13,0.85)) +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(plot.title = element_text(hjust = 0.5, size=15, face="bold")) + # guides(shape=FALSE)+ 
  facet_wrap(~ordered_trt,
             ncol = 2, nrow = 4,
             labeller=treatment_labeller)+
  guides(fill=FALSE, color=FALSE)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15)) # add black square panel around graphic
#dev.off()
```


```{r permanova}
out.parasite<-adonis(formula=pt ~ EPICHL_TRT * COLLET_TRT *RHIZOC_TRT * as.factor(Survey.event), 
                     strata =envi01$PLANT_ID,
                     data=envi01, 
                     permutations=999,
                     method="bray")
out.parasite
```

############## removed uninfected hosts/leaves from ordination 

Terms added sequentially (first to last)

                                                           Df SumsOfSqs   MeanSqs F.Model      R2 Pr(>F)    
EPICHL_TRT                                                  1    0.0019 0.0019026  1.0223 0.00053  0.001 ***
COLLET_TRT                                                  1    0.0090 0.0089508  4.8094 0.00252  0.001 ***
RHIZOC_TRT                                                  1    0.0082 0.0082145  4.4138 0.00231  0.001 ***
as.factor(Survey.event)                                    12    0.3084 0.0257008 13.8094 0.08670  0.001 ***
EPICHL_TRT:COLLET_TRT                                       1    0.0003 0.0002865  0.1539 0.00008  0.001 ***
EPICHL_TRT:RHIZOC_TRT                                       1    0.0204 0.0204091 10.9661 0.00574  0.001 ***
COLLET_TRT:RHIZOC_TRT                                       1    0.0027 0.0026959  1.4486 0.00076  0.001 ***
EPICHL_TRT:as.factor(Survey.event)                         12    0.0112 0.0009341  0.5019 0.00315  0.937    
COLLET_TRT:as.factor(Survey.event)                         12    0.0214 0.0017831  0.9581 0.00602  0.218    
RHIZOC_TRT:as.factor(Survey.event)                         12    0.0191 0.0015907  0.8547 0.00537  0.396    
EPICHL_TRT:COLLET_TRT:RHIZOC_TRT                            1    0.0079 0.0078598  4.2232 0.00221  0.001 ***
EPICHL_TRT:COLLET_TRT:as.factor(Survey.event)              12    0.0124 0.0010294  0.5531 0.00347  0.916    
EPICHL_TRT:RHIZOC_TRT:as.factor(Survey.event)              12    0.0225 0.0018753  1.0076 0.00633  0.198    
COLLET_TRT:RHIZOC_TRT:as.factor(Survey.event)              12    0.0210 0.0017479  0.9392 0.00590  0.265    
EPICHL_TRT:COLLET_TRT:RHIZOC_TRT:as.factor(Survey.event)   12    0.0182 0.0015169  0.8150 0.00512  0.520    
Residuals                                                1651    3.0727 0.0018611         0.86381           
Total                                                    1754    3.5572                   1.00000 

```{r permanova pairwise}
# Benjamini and Hochberg  = fdr; can use method="bonferroni" for more conservative test 
pairwise.adonis <- function(x,factors, sim.method = 'bray', p.adjust.m ='fdr')
  {
  library(vegan)
  co = combn(unique(factors),2)
  pairs = c()
  F.Model =c() 
  R2 = c()
  p.value = c()
  for(elem in 1:ncol(co)){
    ad = adonis(x[factors %in% c(co[1,elem],co[2,elem]),] ~ factors[factors %in% c(co[1,elem],co[2,elem])] , method =sim.method);
    pairs = c(pairs,paste(co[1,elem],'vs',co[2,elem]));
    F.Model =c(F.Model,ad$aov.tab[1,4]);
    R2 = c(R2,ad$aov.tab[1,5]);
    p.value = c(p.value,ad$aov.tab[1,6])
    }
  p.adjusted = p.adjust(p.value,method=p.adjust.m)
  pairw.res = data.frame(pairs,F.Model,R2,p.value,p.adjusted)
  return(pairw.res)
}

out.pair.parasite <-pairwise.adonis(pt, envi01$Treat)
out.pair.parasite<- data.frame(out.pair.parasite)

pdjust.treat <- out.pair.parasite %>% 
  separate(pairs, c("contrast1", "contrast2"), "vs")%>% 
  dplyr::select(contrast1, contrast2, p.adjusted) %>%
  spread(contrast2, p.adjusted, fill = NA)
```
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 Benjamini and Hochberg CORRECT PVALUES  
                                                  pairs    F.Model           R2 p.value  p.adjusted
1                   Epi (+) vs Epi (+) Col (+) Rhiz (+) 6.77095471 1.229359e-02   0.001 0.004666667
2                                    Epi (+) vs Epi (-) 0.76159969 1.780430e-03   0.477 0.534240000
3                           Epi (+) vs Epi (-) Rhiz (+) 0.17044356 3.990060e-04   0.850 0.881481481
4                            Epi (+) vs Epi (-) Col (+) 6.50352761 1.415338e-02   0.005 0.015555556
5                           Epi (+) vs Epi (+) Rhiz (+) 3.99578986 7.291643e-03   0.006 0.016800000
6                            Epi (+) vs Epi (+) Col (+) 0.96473997 1.770280e-03   0.391 0.476000000
7                   Epi (+) vs Epi (-) Col (+) Rhiz (+) 3.23968600 7.309106e-03   0.043 0.080266667
8                   Epi (+) Col (+) Rhiz (+) vs Epi (-) 8.46358942 1.943581e-02   0.001 0.004666667
9          Epi (+) Col (+) Rhiz (+) vs Epi (-) Rhiz (+) 2.67190374 6.218474e-03   0.062 0.108500000
10          Epi (+) Col (+) Rhiz (+) vs Epi (-) Col (+) 4.68989058 1.024687e-02   0.009 0.021000000
11         Epi (+) Col (+) Rhiz (+) vs Epi (+) Rhiz (+) 2.19516378 4.019010e-03   0.084 0.130666667
12          Epi (+) Col (+) Rhiz (+) vs Epi (+) Col (+) 6.03956017 1.098023e-02   0.002 0.007000000
13 Epi (+) Col (+) Rhiz (+) vs Epi (-) Col (+) Rhiz (+) 5.79399527 1.299702e-02   0.007 0.017818182
14                          Epi (-) vs Epi (-) Rhiz (+) 0.82062331 2.640183e-03   0.463 0.534240000
15                           Epi (-) vs Epi (-) Col (+) 7.33344345 2.135954e-02   0.001 0.004666667
16                          Epi (-) vs Epi (+) Rhiz (+) 3.50034693 8.130881e-03   0.013 0.028000000
17                           Epi (-) vs Epi (+) Col (+) 2.02125922 4.711326e-03   0.149 0.208600000
18                  Epi (-) vs Epi (-) Col (+) Rhiz (+) 3.90329157 1.194020e-02   0.021 0.042000000
19                  Epi (-) Rhiz (+) vs Epi (-) Col (+) 2.17190341 6.422483e-03   0.082 0.130666667
20                 Epi (-) Rhiz (+) vs Epi (+) Rhiz (+) 1.13413614 2.649021e-03   0.337 0.428909091
21                  Epi (-) Rhiz (+) vs Epi (+) Col (+) 1.56055491 3.641387e-03   0.194 0.258666667
22         Epi (-) Rhiz (+) vs Epi (-) Col (+) Rhiz (+) 2.40377308 7.387047e-03   0.091 0.134105263
23                  Epi (-) Col (+) vs Epi (+) Rhiz (+) 0.82370834 1.815040e-03   0.506 0.544923077
24                   Epi (-) Col (+) vs Epi (+) Col (+) 8.85847253 1.918006e-02   0.001 0.004666667
25          Epi (-) Col (+) vs Epi (-) Col (+) Rhiz (+) 9.73259495 2.713050e-02   0.001 0.004666667
26                  Epi (+) Rhiz (+) vs Epi (+) Col (+) 5.47355454 9.961452e-03   0.002 0.007000000
27         Epi (+) Rhiz (+) vs Epi (-) Col (+) Rhiz (+) 6.14847894 1.378124e-02   0.001 0.004666667
28          Epi (+) Col (+) vs Epi (-) Col (+) Rhiz (+) 0.01201477 2.730555e-05   0.931 0.931000000
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NEXT STEP: 

(1)	Distance moved (d) by a parasite community can be measured by calculating Euclidean distance between community states (c) at each survey point (i). Here, x and y are the NMDS coordinates, representing the community states (c) based on B-C distances. The greater the distance between community states, the more dissimilar the communities have become over time. 

d= √((x_(i+1) )-x_i  )^2+(y_(i+1)-y_i  )^2

The total trajectory distance is the sum of all distances (d) between sequential community states 	(c which represents the NMDS coordinates):

L(T)= ∑_(i=1)^(n-1)▒d  (c_i,c_(i+1))

And from this I calculate the average distanced traveled by a trajectory: (t) is the time (here 	survey event)  

S(T)=L(T)/(t_n- t_1 )  
```{r distance moved}
dist.pt <- function(x1, y1, x2, y2) sqrt((x2-x1)^2 + (y2-y1)^2) # finds distance between points 

plant_list <- unique(outplant_data$PLANT_ID) #list for the loop 
dist_outplant <- data.frame() # df for output of loop

for (i in plant_list){
  plant_id <- i
  plant_target <- parasite_all %>% 
    filter(PLANT_ID == i)
  
  TIME1_2 <- dist.pt (as.numeric(plant_target[1,8]), as.numeric(plant_target[1,9]),as.numeric(plant_target[2,8]), as.numeric(plant_target[2,9] ))
  TIME2_3 <- dist.pt (as.numeric(plant_target[2,8]), as.numeric(plant_target[2,9]),as.numeric(plant_target[3,8]), as.numeric(plant_target[3,9] ))
  TIME3_4 <- dist.pt (as.numeric(plant_target[3,8]), as.numeric(plant_target[3,9]),as.numeric(plant_target[4,8]), as.numeric(plant_target[4,9] ))
  TIME4_5 <- dist.pt (as.numeric(plant_target[4,8]), as.numeric(plant_target[4,9]),as.numeric(plant_target[5,8]), as.numeric(plant_target[5,9] ))
  TIME5_6 <- dist.pt (as.numeric(plant_target[5,8]), as.numeric(plant_target[5,9]),as.numeric(plant_target[6,8]), as.numeric(plant_target[6,9] ))
  TIME6_7 <- dist.pt (as.numeric(plant_target[6,8]), as.numeric(plant_target[6,9]),as.numeric(plant_target[7,8]), as.numeric(plant_target[7,9] ))
  TIME7_8 <- dist.pt (as.numeric(plant_target[7,8]), as.numeric(plant_target[7,9]),as.numeric(plant_target[8,8]), as.numeric(plant_target[8,9] ))
  TIME8_9 <- dist.pt (as.numeric(plant_target[8,8]), as.numeric(plant_target[8,9]),as.numeric(plant_target[9,8]), as.numeric(plant_target[9,9] ))
  TIME9_10 <- dist.pt (as.numeric(plant_target[9,8]), as.numeric(plant_target[9,9]),as.numeric(plant_target[10,8]), as.numeric(plant_target[10,9] ))
  TIME10_11 <- dist.pt (as.numeric(plant_target[10,8]), as.numeric(plant_target[10,9]),as.numeric(plant_target[11,8]), as.numeric(plant_target[11,9] ))
  TIME11_12 <- dist.pt (as.numeric(plant_target[11,8]), as.numeric(plant_target[11,9]),as.numeric(plant_target[12,8]), as.numeric(plant_target[12,9] ))
  TIME12_13 <- dist.pt (as.numeric(plant_target[12,8]), as.numeric(plant_target[12,9]),as.numeric(plant_target[13,8]), as.numeric(plant_target[13,9] ))
  
  dist_moved <- data.frame(i, TIME1_2, TIME2_3, TIME3_4, TIME4_5, TIME5_6, TIME6_7, TIME7_8, TIME8_9, TIME9_10, TIME10_11, TIME11_12, TIME12_13)
  dist_outplant <-rbind(dist_outplant, dist_moved)
  }

col_head <- c('PLANT_ID', 'TIME1_2', 'TIME2_3', 'TIME3_4', 'TIME4_5', 'TIME5_6', 
              'TIME6_7', 'TIME7_8', 'TIME8_9', 'TIME9_10', 'TIME10_11', 'TIME11_12', 'TIME12_13')

colnames(dist_outplant) <- col_head
```

```{r dist formatting}
pdist_outplant <- merge(dist_outplant, plant_level_outplant, by ="PLANT_ID")

time_btwm <- data.frame(
  Time = c('TIME1_2', 'TIME2_3', 'TIME3_4', 'TIME4_5', 'TIME5_6', 'TIME6_7',
           'TIME7_8', 'TIME8_9', 'TIME9_10', 'TIME10_11', 'TIME11_12', "TIME12_13"),
  Time_step = c(seq(1:12))
  ) 


pdist_outplant <- pdist_outplant %>% 
  mutate(total_distance = rowSums(.[2:13], na.rm=TRUE),
         mean_distance = rowMeans(.[2:13], na.rm=TRUE)) # %>% drop_na() #total distance moved 
head(pdist_outplant)
```

```{r graphics for total distance}
pdist_outplant <- pdist_outplant %>%
  group_by(PLANT_ID, EPICHL_TRT, COLLET_TRT, RHIZOC_TRT, Treat, Treatment.code)%>%
  summarise_all(mean) %>%
  mutate(EPICHL_TRT = as.factor(EPICHL_TRT),
         COLLET_TRT = as.factor(COLLET_TRT),
         RHIZOC_TRT = as.factor(RHIZOC_TRT))%>%
  ungroup()%>%
  filter(total_distance >0 )

pdist_outplant <- merge(pdist_outplant, slopes_leaf_production, by = c("PLANT_ID", "Treat"))

pdist_outplant$EPICHL_TRT <- relevel(pdist_outplant$EPICHL_TRT, ref='inoculated')
pdist_outplant$COLLET_TRT <- relevel(pdist_outplant$COLLET_TRT, ref='inoculated')
pdist_outplant$RHIZOC_TRT <- relevel(pdist_outplant$RHIZOC_TRT, ref='inoculated')

se <- function(x) sqrt(var(x)/length(x))

pdist_outplant <- pdist_outplant %>% 
  mutate(log_distance = log10(total_distance))

dodge <- position_dodge(width = 1)

pdi.mod <-aov(log_distance ~ Treat, pdist_outplant)

library(emmeans)
pdist_mean <-emmeans(pdi.mod, ~ Treat) %>% data.frame()

order_trt <-c( "2Epi (+)"        ,
               "8Epi (+) Col (+) Rhiz (+)",
               "1Epi (-)"      ,
               "5Epi (-) Rhiz (+)" ,
               "3Epi (-) Col (+)"    ,
               "6Epi (+) Rhiz (+)"  ,
               "4Epi (+) Col (+)"    ,
               "7Epi (-) Col (+) Rhiz (+)")

pdist_mean <- merge(pdist_mean, full_treament, by = "Treat")   
pdist_outplant <- merge(pdist_outplant, full_treament, by = 'Treat')
```

```{r plot total distance moved}
#jpeg(filename="total_distance_moved.jpeg", width=120, height=90, units="mm", bg="white", res=300)
ggplot(data=pdist_mean, aes(x=ordered_trt, y = emmean,fill=ordered_trt)) +
  geom_point(aes(x=ordered_trt, y = log_distance , fill=ordered_trt), pch=21, alpha=0.3,
             position=position_jitterdodge(dodge.width=1,  jitter.width = 0.3), data= pdist_outplant)+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), position=dodge, width=0.1, data=pdist_mean) +
  geom_point(aes(x=ordered_trt, y = emmean , fill=ordered_trt ), 
             pch=21, size=3, alpha=1)+ 
  scale_fill_manual(values=c('white','white','white','white',
                             'white','white','white','white')) + 
  theme_pubr() +
  labs(x="", y="log cumulative community change")+
   annotate("text", x = 1, y = 0.4, label = "ab", size=3) + #17 never sprayed
   annotate("text", x = 2, y = 0.4, label = "ab", size=3) +  #17 always sprayed
   annotate("text", x = 3, y = 0.5, label = "b", size=3) +  #17 always sprayed
   annotate("text", x = 4, y = 0.45, label = "ab", size=3) +  #17 crp
   annotate("text", x = 5, y = 0.35, label = "ab", size=3) + #17 never sprayed
   annotate("text", x = 6, y = 0.35, label = "ab", size=3) +  #17 cr->p
   annotate("text", x = 7, y = 0.54, label = "a", size=3) +  #17 cr->p
   annotate("text", x = 8, y = 0.45, label = "ab", size=3) +  #17 crp
  theme(axis.text.x = element_text( angle=0, hjust = 1, vjust = 0.5)) +
  scale_x_discrete(labels=c("2Epi (+)"    = "Epi",
                            "8Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
                            "1Epi (-)"    = "No symbiont",
                            "5Epi (-) Rhiz (+)"   = "Rhiz",
                            "3Epi (-) Col (+)"    ="Col",
                            "6Epi (+) Rhiz (+)"  = "Epi + Rhiz",
                            "4Epi (+) Col (+)" ="Epi + Col",
                            "7Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz")
                   )+
  coord_flip()+
  guides(fill=FALSE) 
#dev.off()
```


```{r total distance model}
# # set reference level here for the contrasts  (set as.factor, and then set reference level) 
pdist_outplant <- pdist_outplant %>%
  mutate_at(c('EPICHL_TRT','COLLET_TRT', 'RHIZOC_TRT'), as.factor) #convert columns to factors

pdist_outplant <- within(pdist_outplant, EPICHL_TRT <- relevel(EPICHL_TRT, ref = 'free'))
levels(pdist_outplant$EPICHL_TRT)[1] #check
pdist_outplant <- within(pdist_outplant, COLLET_TRT <- relevel(COLLET_TRT, ref = 'mock'))
levels(pdist_outplant$COLLET_TRT)[1] #check
pdist_outplant <- within(pdist_outplant, RHIZOC_TRT <- relevel(RHIZOC_TRT, ref = 'mock'))
levels(pdist_outplant$RHIZOC_TRT)[1] #check

tot.mod2 <- aov(log_distance ~ EPICHL_TRT* COLLET_TRT* RHIZOC_TRT, data= pdist_outplant)
tot.mod2 <- lm(log_distance ~ EPICHL_TRT* COLLET_TRT* RHIZOC_TRT, data= pdist_outplant)
summary(tot.mod2)

contrasts=c("contr.sum")
library(car)
tot.mod2.t3 <-Anova(tot.mod2, type ='III' )
tot.mod2.t3

library(DescTools)
EtaSq(tot.mod2, type = 3) # effect size

```
nova Table (Type III tests)

Response: log_distance
                                  Sum Sq  Df F value   Pr(>F)   
(Intercept)                       1.4880   1  8.1389 0.005072 **
EPICHL_TRT                        0.0297   1  0.1626 0.687464   
COLLET_TRT                        1.0750   1  5.8800 0.016744 * 
RHIZOC_TRT                        0.0158   1  0.0866 0.768979   
EPICHL_TRT:COLLET_TRT             0.4569   1  2.4991 0.116439   
EPICHL_TRT:RHIZOC_TRT             0.0423   1  0.2313 0.631390   
COLLET_TRT:RHIZOC_TRT             0.8672   1  4.7434 0.031287 * 
EPICHL_TRT:COLLET_TRT:RHIZOC_TRT  0.4845   1  2.6500 0.106067   
Residuals                        22.8533 125                    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                         log_distance groups
Epi (-) Col (+) Rhiz (+)   0.22601030      a
Epi (-) Rhiz (+)           0.19943320     ab
Epi (+) Rhiz (+)           0.17162445     ab
Epi (+) Col (+)            0.15806457     ab
Epi (-)                    0.14840281     ab
Epi (+) Col (+) Rhiz (+)   0.14630006     ab
Epi (+)                    0.14409726     ab
Epi (-) Col (+)            0.07643524      b

eta.sq  eta.sq.part
EPICHL_TRT                       0.0011563885 0.0012991038
COLLET_TRT                       0.0418177641 0.0449264690
RHIZOC_TRT                       0.0006161869 0.0006926538
EPICHL_TRT:COLLET_TRT            0.0177732834 0.0196008657
EPICHL_TRT:RHIZOC_TRT            0.0016450982 0.0018471134
COLLET_TRT:RHIZOC_TRT            0.0337349001 0.0365602096
EPICHL_TRT:COLLET_TRT:RHIZOC_TRT 0.0188465740 0.0207599475


Plants initially inoculated with different fungal symbionts may exhibit different parasite community trajectories. To test this hypothesis, I calculated the treatment centroid of the outplants for each survey event and then tested for convergence between trajectories. Here, I calculated Euclidean distance between community states for time paired treatment groups (e.g., distance between group i and group j at time step 1; group i and  group j at time step 2; etc.. see figure below). 

d= √((x_i )-x_j  )^2 + (y_i-y_j  )^2

Then I analyzed the relationship between distance between treatment groups (i.e., dissimilarity between community states) and time, to evaluate whether community trajectories become more dissimilar as communities develop. I used the non-parametric Mann-Kendall test to detect monotonic trends between dissimilarity (i.e., distance between treatment centroids) and time. Trajectories that are diverging over time have a tau value greater than 0 (i.e., positive relationship between dissimilarity and time), while trajectories that are converging over time are less than 0 (i.e., negative relationship between dissimilarity and time). 
```{r trajectory}
###################################################################################################
# distance between treatment centroids: how dissimilar are the trajectories btwn groups 
###################################################################################################
dist.pt <- function(x1, y1, x2, y2) sqrt((x2-x1)^2 + (y2-y1)^2) # finds distance between points 

cent <- parasite_all %>%
  group_by(Treat, Survey.event) %>%
  summarise_at(c("NMDS1", 'NMDS2'), mean) 

trt_list <- unique(cent$Treat)
trt_list2 <-c("Epi (-) Col (+)",
              "Epi (-) Col (+) Rhiz (+)",
              "Epi (-) Rhiz (+)", 
              "Epi (+)", "Epi (+) Col (+)","Epi (+) Col (+) Rhiz (+)", "Epi (+) Rhiz (+)",  "Epi (-)")

dist_btw_trt <- data.frame()

for (i in trt_list){
  for(j in trt_list){
    
    treat <- i
    treat2 <- j 
    
    #trt_one <- cent %>% filter  (Treat == "Epi (-)" )
    #trt_two <- cent %>% filter  (Treat == "Epi (+) Col (+)" )
    trt_one <- cent %>% filter  (Treat == i )
    trt_two <- cent %>% filter  (Treat == j )
    trt_merge <- merge(trt_one, trt_two, by = c("Survey.event"))
    
    TIME1 <- dist.pt (trt_merge[1,3], trt_merge[1,4],trt_merge[1,6], trt_merge[1,7] )
    TIME2<- dist.pt (trt_merge[2,3], trt_merge[2,4],trt_merge[2,6], trt_merge[2,7] )
    TIME3 <- dist.pt (trt_merge[3,3], trt_merge[3,4],trt_merge[3,6], trt_merge[3,7] )
    TIME4 <- dist.pt (trt_merge[4,3], trt_merge[4,4],trt_merge[4,6], trt_merge[4,7] )
    TIME5 <- dist.pt (trt_merge[5,3], trt_merge[5,4],trt_merge[5,6], trt_merge[5,7] )
    TIME6 <- dist.pt (trt_merge[6,3], trt_merge[6,4],trt_merge[6,6], trt_merge[6,7] )
    TIME7 <- dist.pt (trt_merge[7,3], trt_merge[7,4],trt_merge[7,6], trt_merge[7,7] )
    TIME8 <- dist.pt (trt_merge[8,3], trt_merge[8,4],trt_merge[8,6], trt_merge[8,7] )
    TIME9 <- dist.pt (trt_merge[9,3], trt_merge[9,4],trt_merge[9,6], trt_merge[9,7] )
    TIME10 <- dist.pt (trt_merge[10,3], trt_merge[10,4],trt_merge[10,6], trt_merge[10,7] )
    TIME11 <- dist.pt (trt_merge[11,3], trt_merge[11,4],trt_merge[11,6], trt_merge[11,7] )
    TIME12 <- dist.pt (trt_merge[12,3], trt_merge[12,4],trt_merge[12,6], trt_merge[12,7] )
    TIME13 <- dist.pt (trt_merge[13,3], trt_merge[13,4],trt_merge[13,6], trt_merge[13,7] )
    
    
    dist_btwn_plant <- data.frame(i, j, TIME1, TIME2, TIME3, TIME4, TIME5, TIME6, TIME7, TIME8, TIME9, TIME10, TIME11, TIME12, TIME13)
    dist_btw_trt <-rbind(dist_btw_trt, dist_btwn_plant)
  }
}

col_head <- c('Treat1',"Treat2", '1',"2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13")
colnames(dist_btw_trt) <- col_head

dist_btw_tidy <- dist_btw_trt %>% gather(time, distance, 3:15) %>%
  mutate(type =rep("centroid"))

sample_days2 <-data.frame(time = 1:13,
           days=c(1, 4, 6, 11,14, 18, 21, 25, 28, 32, 35, 39,42))

dist_btw_tidy  <- merge(dist_btw_tidy , sample_days2, by = c('time'))

```

```{r man_kendall}
###################################################################################################
# trajectory analysis 
###################################################################################################
plant_mk_cent <- dist_btw_tidy %>% 
  filter(Treat1== "Epi (-)") %>%
  filter(Treat2 == "Epi (-) Col (+)") %>%
  mutate(time = as.numeric(time))%>% arrange(time)

plant_mk_test1 <- mk.test(plant_mk_cent$distance)
plant_slope <- sens.slope(plant_mk_cent$distance)


plant_mk_test1$estimates[3] # extract tau
plant_mk_test1$p.value # extract pvalue from trend test 
plant_slope$estimates # extract slope 
plant_slope$p.value

# okay moving on... 
trt_level_mk_test <- dist_btw_tidy %>% 
  group_by(Treat1, Treat2) %>%  
  mutate(time = as.numeric(time))%>% 
  arrange(time) %>%
  mutate(mann_kendall_tau = mk.test(distance)$estimates[3],
         mann_kendall_pvalue = mk.test(distance)$p.value,
         sens_slope = sens.slope(distance)$estimate,
         sens_pvalue = sens.slope(distance)$p.value) %>%
  group_by(Treat1, Treat2) %>%
  summarise_at(c("mann_kendall_tau", "mann_kendall_pvalue", "sens_slope", "sens_pvalue"), mean)

```

```{r slope graphic example}
slope_null <- trt_level_mk_test %>%
  filter(Treat1 == "Epi (-)") %>%
  group_by(Treat1, Treat2) %>%
  summarise_at(c("mann_kendall_tau", "mann_kendall_pvalue", "sens_slope"), mean)

slope_null %>% 
  filter(sens_slope > 0 )%>%
  ggplot()+
  geom_point(aes(x = sens_slope,y= Treat2), size =5,pch=21)+
  labs(x= "Sens slope", y = "")+
  ggtitle("Rate of divergence between Epi (-) parasite communities")+
  xlim(c(0,0.005))+
  rita_theme

slope_data <- trt_level_mk_test %>%
  drop_na()
  
sens.mod <-aov(sens_slope ~ Treat1, slope_data)

library(emmeans)
slope_est <-emmeans(sens.mod, ~ Treat1) %>% data.frame()

trt_level_mk_test %>%
  drop_na()%>%
  group_by(Treat1)%>%
  summarise(mean_tau=mean(mann_kendall_tau))

#jpeg(filename="sens_slope_treatment.jpeg", width=90, height=90, units="mm", bg="white", res=300)
slope_est %>% 
  ggplot(aes(y =emmean,x= Treat1, group=Treat1))+
  geom_point(aes(y =emmean,x= Treat1), size =5,pch=21, fill='black')+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL),  width=0.1, data=slope_est) +
    labs(y= "Sens slope", x = "")+
 # xlim(c(0.001,0.005))+
    rita_theme+
    scale_x_discrete(labels=c("Epi (+)"    = "Epi",
                            "Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
                            "Epi (-)"    = "No symbiont",
                            "Epi (-) Rhiz (+)"   = "Rhiz",
                            "Epi (-) Col (+)"    ="Col",
                            "Epi (+) Rhiz (+)"  = "Epi + Rhiz",
                            "Epi (+) Col (+)" ="Epi + Col",
                            "Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz"))+
  coord_flip()
#dev.off()
```

```{r graphic_convergence}
converg_matrix <- trt_level_mk_test %>% 
  select(Treat1, Treat2, mann_kendall_tau) %>% # arrange(Treat1) %>% arrange(Treat)%>%
  spread(Treat2, mann_kendall_tau) %>% 
  replace(., is.na(.), 0)

# Get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
  cormat[upper.tri(cormat)] <- NA
  return(cormat)
}

signif <- trt_level_mk_test %>%
mutate(signif.p = case_when((mann_kendall_pvalue < 0.05) ~ 0, 
                              (mann_kendall_pvalue > 0.05) ~ 1))%>%
  select(Treat1, Treat2, mann_kendall_pvalue, signif.p) 
conv_low <- get_lower_tri(converg_matrix)
convergence <- conv_low %>% 
  gather(Treat2, mann_kendall_tau, 2:9) %>%
  mutate(index = "Bray-Curtis")
convergence <- merge(convergence, signif, by = c("Treat1", "Treat2"))

#jpeg(filename="convergence_test_centroid_severity.jpeg", width=90, height=90, units="mm", bg="white", res=300)
mktrend <-convergence%>% 
  ggplot(aes(x=Treat1, y = Treat2, fill=mann_kendall_tau))+
  theme_bw(base_size =11.5)+
  geom_raster(aes(x=Treat1, y = Treat2, fill=mann_kendall_tau))+
  scale_fill_gradientn(limits = c(-1,1), 
                       breaks=c(-1,0,1),
                       colours=c('#bdbdbd','#f1eef6','#045a8d'),
                       na.value = 'white',
                       name='Tau')+
  labs(x="", y="") +
  geom_text(aes(x=Treat1, y = Treat2, label=round(mann_kendall_tau,2)), size=3, vjust=1)+ 
  geom_text(data=subset(convergence, mann_kendall_pvalue < 0.05), 
            aes(x=Treat1, y = Treat2, label="*"), 
            size=5, color="white", vjust=0.2, hjust=-1)+ 
  geom_text(data=subset(convergence, mann_kendall_tau < -0.9),
            aes(x=Treat1, y = Treat2, label=round(mann_kendall_tau,2)),
            size=5, color="#bdbdbd",  vjust=1)+ 
 theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    # panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(0.5, 0.8),
    legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                               title.position = "top", title.hjust = 0.5))+
  scale_y_discrete(labels=c("Epi (+)"    = "Epi",
                            "Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
                            "Epi (-)"    = "No symbiont",
                            "Epi (-) Rhiz (+)"   = "Rhiz",
                            "Epi (-) Col (+)"    ="Col",
                            "Epi (+) Rhiz (+)"  = "Epi + Rhiz",
                            "Epi (+) Col (+)" ="Epi + Col",
                            "Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz"), 
                   position = 'right'
  )+
  guides(fill=FALSE)
mktrend
#dev.off()

```

supplemental graphic of pvalues 
```{r graphic convergence_pvalues}

converg_matrix2 <- trt_level_mk_test %>% 
  select(Treat1, Treat2, mann_kendall_pvalue) %>% # arrange(Treat1) %>% arrange(Treat)%>%
  spread(Treat2, mann_kendall_pvalue) %>% 
  replace(., is.na(.), 0)

# Get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
  cormat[upper.tri(cormat)] <- NA
  return(cormat)
}

conv_low2 <- get_lower_tri(converg_matrix2)
convergence_2 <- conv_low2 %>% 
  gather(Treat2, mann_kendall_pvalue, 2:9) %>%
  mutate(index = "Bray-Curtis")

#jpeg(filename="convergence_pvalues_centroid_severity.jpeg", width=90, height=90, units="mm", bg="white", res=300)
convergence_2%>% 
  ggplot(aes(x=Treat1, y = Treat2, fill=mann_kendall_pvalue))+
  theme_bw(base_size =8)+
  geom_raster(aes(x=Treat1, y = Treat2, fill=mann_kendall_pvalue)) +
  scale_fill_gradientn(limits = c(0,0.68), 
                       breaks=c(0,0.05,0.06,0.68),
                       colours=c('#b10026','#ffffcc','#ffffcc', '#ffffcc'),
                       na.value = 'white',
                       name='Tau')+
  labs(x="", y="") +
  geom_text(aes(x=Treat1, y = Treat2, label=round(mann_kendall_pvalue,2)), size=2, vjust=1)+ 
  geom_text(data=subset(convergence, mann_kendall_pvalue < 0.05), 
            aes(x=Treat1, y = Treat2, label="*"), 
            size=5, color="white", vjust=0.2, hjust=-1)+ 
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    # panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(0.5, 0.8),
    legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                               title.position = "top", title.hjust = 0.5))+
  theme(axis.text.x = element_text( angle=90, hjust = 1, vjust = 0.5)) +
  scale_x_discrete(labels=c("Epi (+)"    = "Epi",
                            "Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
                            "Epi (-)"    = "No symbiont",
                            "Epi (-) Rhiz (+)"   = "Rhiz",
                            "Epi (-) Col (+)"    ="Col",
                            "Epi (+) Rhiz (+)"  = "Epi + Rhiz",
                            "Epi (+) Col (+)" ="Epi + Col",
                            "Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz")
  )+
  scale_y_discrete(labels=c("Epi (+)"    = "Epi",
                            "Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
                            "Epi (-)"    = "No symbiont",
                            "Epi (-) Rhiz (+)"   = "Rhiz",
                            "Epi (-) Col (+)"    ="Col",
                            "Epi (+) Rhiz (+)"  = "Epi + Rhiz",
                            "Epi (+) Col (+)" ="Epi + Col",
                            "Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz"), 
                   position = 'right'
  )+
  guides(fill=FALSE)
#dev.off()

```

Graphic showing the sens slope
```{r graphic sens_slope}

converg_matrix3 <- trt_level_mk_test %>% 
  select(Treat1, Treat2, sens_slope) %>% # arrange(Treat1) %>% arrange(Treat)%>%
  spread(Treat2, sens_slope) %>% 
  replace(., is.na(.), 0)

# Get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
  cormat[upper.tri(cormat)] <- NA
  return(cormat)
}

conv_low3 <- get_lower_tri(converg_matrix3)
convergence_3 <- conv_low3 %>% 
  gather(Treat2, sens_slope, 2:9) %>%
  mutate(index = "Bray-Curtis")

#jpeg(filename="convergence_senslope_centroid_severity.jpeg", width=90, height=90, units="mm", bg="white", res=300)
sensslope <-convergence_3%>% 
  ggplot(aes(x=Treat1, y = Treat2, fill=sens_slope))+
  theme_bw(base_size =11.5)+
  geom_raster(aes(x=Treat1, y = Treat2, fill=sens_slope)) +
  scale_fill_gradientn(limits = c(0,0.006), 
                       breaks=c(0,0.006),
                       colours=c('#edf8e9', '#238b45'),
                       na.value = 'white',
                       name='Tau')+
  labs(x="", y="") +
  geom_text(aes(x=Treat1, y = Treat2, label=round(sens_slope,3)), size=2.75, vjust=1)+ 
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    # panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(0.5, 0.8),
    legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                               title.position = "top", title.hjust = 0.5))+
  theme(axis.text.x = element_text( angle=90, hjust = 1, vjust = 0.5)) +
  scale_x_discrete(labels=c("Epi (+)"    = "Epi",
                            "Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
                            "Epi (-)"    = "No symbiont",
                            "Epi (-) Rhiz (+)"   = "Rhiz",
                            "Epi (-) Col (+)"    ="Col",
                            "Epi (+) Rhiz (+)"  = "Epi + Rhiz",
                            "Epi (+) Col (+)" ="Epi + Col",
                            "Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz")
  )+
  scale_y_discrete(labels=c("Epi (+)"    = "Epi",
                            "Epi (+) Col (+) Rhiz (+)" = "Epi + Col + Rhiz",
                            "Epi (-)"    = "No symbiont",
                            "Epi (-) Rhiz (+)"   = "Rhiz",
                            "Epi (-) Col (+)"    ="Col",
                            "Epi (+) Rhiz (+)"  = "Epi + Rhiz",
                            "Epi (+) Col (+)" ="Epi + Col",
                            "Epi (-) Col (+) Rhiz (+)" = "Col + Rhiz"), 
                   position = 'right'
  )+
  guides(fill=FALSE)
sensslope
#dev.off()

```

```{r mktren and sens graphic}
#jpeg(filename="convergence_graphics_trend_slope.jpeg", width=90, height=180, units="mm", bg="white", res=300)
ggarrange(mktrend, sensslope, ncol = 1, nrow = 2, 
          heights = c(1, 1.3),align = "v",
          labels = 'AUTO')
#dev.off()
```

To assess drift within a treatment, I calculated the distance from the centroid for each outplant within a treatment group.   

```{r drift}
###################################################################################################
# calculate distance between outplants and their centroid
dist.pt <- function(x1, y1, x2, y2) sqrt((x2-x1)^2 + (y2-y1)^2) # finds distance between points 

outplant_list <- unique(parasite_all$PLANT_ID)

cent.2 <- parasite_all %>%
  group_by(Survey.event) %>%
  summarise_at(c("NMDS1", 'NMDS2'), mean)


#parasite_nmds <- merge(parasite_all, cent, by =c ("Treat", "Survey.event"))
parasite_nmds <- merge(parasite_all, cent.2, by =c ( "Survey.event"))

dis_centroid <- data.frame()

for (i in outplant_list){

    plant <- i
    
   # trt_merge <- parasite_nmds %>% filter(PLANT_ID == 1) %>% arrange(Survey.event)
    trt_merge <- parasite_nmds %>% 
      filter  (PLANT_ID== i)%>%
      arrange(Survey.event)
    
    # x, y coordinates for outplant i row 8,9
    # x, y coordinates for centroid of treattmeant row 11,12
    
    
    TIME1 <- dist.pt (trt_merge[1,8], trt_merge[1,9],trt_merge[1,10], trt_merge[1,11] )
    TIME2 <- dist.pt (trt_merge[2,8], trt_merge[2,9],trt_merge[2,10], trt_merge[2,11] )
    TIME3 <- dist.pt (trt_merge[3,8], trt_merge[3,9],trt_merge[3,10], trt_merge[3,11] )
    TIME4 <- dist.pt (trt_merge[4,8], trt_merge[4,9],trt_merge[4,10], trt_merge[4,11] )
    TIME5 <- dist.pt (trt_merge[5,8], trt_merge[5,9],trt_merge[5,10], trt_merge[5,11] )
    TIME6 <- dist.pt (trt_merge[6,8], trt_merge[6,9],trt_merge[6,10], trt_merge[6,11] )
    TIME7 <- dist.pt (trt_merge[7,8], trt_merge[7,9],trt_merge[7,10], trt_merge[7,11] )
    TIME8 <- dist.pt (trt_merge[8,8], trt_merge[8,9],trt_merge[8,10], trt_merge[8,11] )
    TIME9 <- dist.pt (trt_merge[9,8], trt_merge[9,9],trt_merge[9,10], trt_merge[9,11] )
    TIME10 <- dist.pt (trt_merge[10,8], trt_merge[10,9],trt_merge[10,10], trt_merge[10,11] )
    TIME11 <- dist.pt (trt_merge[11,8], trt_merge[11,9],trt_merge[11,10], trt_merge[11,11] )
    TIME12 <- dist.pt (trt_merge[12,8], trt_merge[12,9],trt_merge[12,10], trt_merge[12,11] )
    TIME13 <- dist.pt (trt_merge[13,8], trt_merge[13,9],trt_merge[13,10], trt_merge[13,11] )
    
    
    dist_btwn_plant <- data.frame(i,
                                 # trt_merge$Treat, 
                                  TIME1, TIME2, TIME3, TIME4, TIME5, TIME6, TIME7, 
                                  TIME8, TIME9, TIME10, TIME11, TIME12, TIME13)
    dis_centroid <-rbind(dis_centroid, dist_btwn_plant)

}

col_head <- c('PLANT_ID',
             # "Treat", 
              '1',"2", "3", "4", "5", "6", "7",
              "8", "9", "10", "11", "12", "13")
colnames(dis_centroid) <- col_head

distance_centroid <- dis_centroid %>%
  group_by(PLANT_ID #, Treat
           ) %>%
  summarise_all(mean) %>%
  gather(time, Distance,2:14 #3:15
         )%>%
  drop_na()
```


```{r distance_from_centroid}
distance_centroid <- merge(distance_centroid, sample_days2, by = c("time"))
distance_centroid <- merge(distance_centroid, leafdemographics, by =c("PLANT_ID", "days"))
```
Segmented model for drift analysis 

```{r segmented model}
library(segmented)
library(nlme)

cent.model <-lme(log10(Distance+1) ~ days, random=~1|PLANT_ID, data= distance_centroid) #random intercept
#cent.model.2 <-lme(log10(Distance+1) ~ days*total_leaves, random=~1|PLANT_ID, data= distance_centroid) #random intercept
#cent.model<-lme(mean_age ~ days, random=~1|PLANT_ID, data= distance_centroid) #random intercept

summary(cent.model)
#summary(cent.model.2)

#cent.model <-lmer(log10(Distance+1) ~ days+ (1|PLANT_ID), data= distance_centroid) #random intercept
cent.seg <-segmented(cent.model, seg.Z = ~days, npsi = 1)
slope(cent.seg,  .coef=fixef(cent.seg))

mean_dis <-distance_centroid %>%
  group_by(days)%>%
  summarise(mean_distance = mean(log10(Distance+1)))

#jpeg(filename="segmented_drift_model.jpeg", width=120, height=90, units="mm", bg="white", res=300)
par(mar = c(4, 4, 1, 1)) # Set the margin on all sides to 2
plot.segmented(cent.seg, "days", .coef=fixef(cent.seg), col='black', rug=TRUE, #dens.rug = TRUE,
               #shade=TRUE,
               lwd=2, conf.level=.95,xlab="days",
               ylab="log distance to the centroid")
points(x=mean_dis$days, y=mean_dis$mean_distance, cex=1.25)
#dev.off()

confint.segmented(cent.seg, "days", .coef=fixef(cent.seg))
cent.seg$coefficients$fixed
cent.fit <-cent.seg$fitted
model.cent <- data.frame(days = distance_centroid$days,
                         fitted = cent.fit)
out.cent <-data.frame(cent.seg$model)

distance_centroid %>%
  group_by(days)%>%
  mutate(mean_distance = mean(log10(Distance+1))) %>%
  ungroup()%>%
  ggplot(aes(x= days, y = mean_distance))+
  geom_line(aes(x= days, y = fitted.fixed), data= model.cent, lwd=1.25)+
  geom_point(aes(x=days, y = mean_distance), pch=21, size=3)+
  labs(x="days", y="distance from the centroid")+
  geom_vline(xintercept = 25, lwd=1, col="grey", lty=2)+
  rita_theme

```
